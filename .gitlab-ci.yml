# GitLab CI/CD Pipeline

stages:
  - lint
  - test
  - build
  - deploy

variables:
  DOCKER_IMAGE: $CI_REGISTRY_IMAGE
  DOCKER_TAG: $CI_COMMIT_SHORT_SHA
  GO_VERSION: "1.22"

# ============================================
# Lint Stage
# ============================================
lint:
  stage: lint
  image: golangci/golangci-lint:v1.56-alpine
  script:
    - golangci-lint run ./...
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

proto-lint:
  stage: lint
  image: bufbuild/buf:latest
  script:
    - buf lint api/
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  allow_failure: true

# ============================================
# Test Stage
# ============================================
test:
  stage: test
  image: golang:${GO_VERSION}-alpine
  script:
    - go test -v -race -coverprofile=coverage.out ./...
    - go tool cover -func=coverage.out
  coverage: '/total:\s+\(statements\)\s+(\d+\.\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.out
    paths:
      - coverage.out
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ============================================
# Build Stage
# ============================================
build:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build
      --build-arg VERSION=$CI_COMMIT_SHORT_SHA
      --build-arg BUILD_TIME=$(date -u '+%Y-%m-%d_%H:%M:%S')
      -t $DOCKER_IMAGE:$DOCKER_TAG
      -t $DOCKER_IMAGE:latest
      -f docker/Dockerfile .
    - docker push $DOCKER_IMAGE:$DOCKER_TAG
    - docker push $DOCKER_IMAGE:latest
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

build-feature:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build
      --build-arg VERSION=$CI_COMMIT_SHORT_SHA
      -t $DOCKER_IMAGE:$CI_COMMIT_REF_SLUG
      -f docker/Dockerfile .
    - docker push $DOCKER_IMAGE:$CI_COMMIT_REF_SLUG
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# ============================================
# Deploy Stage
# ============================================
deploy-staging:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - kubectl set image deployment/user-service
      user-service=$DOCKER_IMAGE:$DOCKER_TAG
      -n staging
  environment:
    name: staging
    url: https://staging.example.com
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  when: manual

deploy-production:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - kubectl set image deployment/user-service
      user-service=$DOCKER_IMAGE:$DOCKER_TAG
      -n production
  environment:
    name: production
    url: https://api.example.com
  rules:
    - if: $CI_COMMIT_TAG
  when: manual
  needs:
    - deploy-staging